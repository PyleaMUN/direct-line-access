<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyleaMUN Direct Line Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the Inter font and overall aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #fbcfe8, #a78bfa); /* Flipped gradient for access page */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            overflow-x: hidden; /* Prevent horizontal scrolling */
            overflow-y: auto; /* Allow vertical scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #a78bfa;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #fbcfe8;
            border-radius: 10px;
            cursor: grab;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #f472b6;
        }

        /* Container styling for login and dashboard */
        .container {
            background-color: #ffffff; /* White background */
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Softer shadow */
            padding: 2rem; /* p-8 */
            width: 100%;
            max-width: 4xl; /* Larger max width for dashboard */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Title styling */
        h1 {
            font-family: 'Fredoka One', cursive;
            color: #6d28d9; /* Purple-700 */
            font-size: 2.5rem; /* text-4xl */
            margin-bottom: 1.5rem; /* mb-6 */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        @media (max-width: 640px) { /* Tailwind's sm breakpoint */
            h1 {
                font-size: 2rem; /* text-3xl on small screens */
            }
        }

        /* Form group styling */
        .form-group {
            margin-bottom: 1.25rem;
            width: 100%;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }
        input[type="password"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #f9fafb;
            color: #1f2937;
        }
        input[type="password"]:focus, select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.5);
            background-color: #ffffff;
        }

        /* Button styling */
        button {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background-color: #8b5cf6;
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            margin-top: 1.5rem;
        }
        button:hover {
            background-color: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(109, 40, 217, 0.5);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
        }
        button.action-button {
            background-color: #4CAF50; /* Green for success actions */
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            width: auto; /* Override full width */
        }
        button.action-button:hover {
            background-color: #45a049;
        }
        button.delete-button {
            background-color: #f44336; /* Red for delete */
        }
        button.delete-button:hover {
            background-color: #da190b;
        }
        button.info-button {
            background-color: #2196F3; /* Blue for info */
        }
        button.info-button:hover {
            background-color: #0b7dda;
        }


        /* Message box for success/error */
        .message-box {
            background-color: #e0f2f7;
            color: #00796b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-weight: 500;
            display: none;
            width: 100%;
            text-align: center;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.5rem;
            color: #6d28d9;
            flex-direction: column;
            gap: 1rem;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #a78bfa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Alert/Message Box HTML (instead of alert()) */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .custom-alert-box {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%;
            min-width: 280px;
            font-family: 'Inter', sans-serif;
        }
        .custom-alert-box h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #6d28d9;
            margin-bottom: 1rem;
        }
        .custom-alert-box p {
            font-size: 1rem;
            color: #4b5563;
            margin-bottom: 1.5rem;
        }
        .custom-alert-box button {
            background-color: #a78bfa;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .custom-alert-box button:hover {
            background-color: #8b5cf6;
        }

        /* Query Card Styling */
        .query-card {
            background-color: #f9fafb; /* Light gray background */
            border: 1px solid #e5e7eb; /* Gray-200 border */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 1rem; /* mb-4 */
            text-align: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease-in-out;
        }
        .query-card:hover {
            transform: translateY(-3px);
        }
        .query-card h3 {
            font-weight: 700; /* font-bold */
            color: #374151; /* Gray-800 */
            margin-bottom: 0.5rem;
            font-size: 1.125rem; /* text-lg */
        }
        .query-card p {
            color: #4b5563; /* Gray-700 */
            font-size: 0.9rem; /* text-sm */
            margin-bottom: 0.5rem;
        }
        .query-card .status-new {
            color: #ef4444; /* Red-500 */
            font-weight: 600;
        }
        .query-card .status-reviewed {
            color: #f59e0b; /* Amber-500 */
            font-weight: 600;
        }
        .query-card .status-answered {
            color: #22c55e; /* Green-500 */
            font-weight: 600;
        }
        .query-card .status-archived {
            color: #6b7280; /* Gray-500 */
            font-weight: 600;
        }
        .query-card .answer-section {
            background-color: #eef2ff; /* Indigo-50 */
            border-left: 4px solid #6366f1; /* Indigo-500 */
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
        }
        .query-card .answer-section strong {
            color: #4338ca; /* Indigo-700 */
        }
        .query-card .answer-input-group {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .query-card .answer-input-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            resize: vertical;
            min-height: 60px;
        }
        .query-card .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end; /* Align buttons to the right */
        }
        .query-card .action-buttons button {
            flex-grow: 1; /* Allow buttons to grow */
            max-width: fit-content; /* Prevent them from taking full width */
        }
        @media (min-width: 640px) { /* Tailwind's sm breakpoint */
            .query-card .action-buttons button {
                flex-grow: 0; /* Don't grow on larger screens */
            }
        }

        /* FAQ Section Styling */
        #faq-management-section {
            margin-top: 2rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 2rem;
        }
        #faq-management-section h2 {
            font-family: 'Fredoka One', cursive;
            color: #6d28d9;
            font-size: 2rem;
            margin-bottom: 1.5rem;
        }
        .faq-item {
            background-color: #f0f9ff; /* Sky-50 */
            border: 1px solid #bae6fd; /* Sky-200 */
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            text-align: left;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .faq-item strong {
            color: #0369a1; /* Sky-700 */
        }
        .faq-item p {
            color: #075985; /* Sky-800 */
            margin-top: 0.5rem;
        }
        .faq-item .faq-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }
        .faq-item .faq-actions button {
            width: auto;
            flex-grow: 0;
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <p>Processing...</p>
    </div>

    <div id="custom-alert-overlay" class="custom-alert-overlay hidden">
        <div class="custom-alert-box">
            <h3 id="custom-alert-title"></h3>
            <p id="custom-alert-message"></p>
            <button id="custom-alert-ok-button">OK</button>
        </div>
    </div>

    <div id="confirmation-overlay" class="custom-alert-overlay hidden">
        <div class="custom-alert-box">
            <h3 id="confirmation-title">Confirm Action</h3>
            <p id="confirmation-message">Are you sure you want to perform this action?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmation-cancel-button" class="bg-gray-400 hover:bg-gray-500">Cancel</button>
                <button id="confirmation-ok-button" class="bg-red-500 hover:bg-red-600">Confirm</button>
            </div>
        </div>
    </div>

    <div class="container max-w-4xl">
        <img src="logo.png" alt="PyleaMUN Logo" class="w-32 h-auto mb-6">
        <h1 class="font-extrabold">PyleaMUN Direct Line Access</h1>

        <div id="login-section" class="w-full max-w-md mx-auto">
            <p class="text-gray-600 mb-8 text-sm">Enter your staff password to access the dashboard.</p>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Enter password" class="shadow-sm">
            </div>
            <button id="loginButton">Login</button>
            <div id="loginMessageBox" class="message-box mt-4"></div>
        </div>

        <div id="committee-selection-section" class="w-full max-w-md mx-auto hidden">
            <p class="text-gray-600 mb-4 text-sm">Please select your committee to view queries.</p>
            <div class="form-group">
                <label for="selectCommitteeLogin">Select Your Committee:</label>
                <select id="selectCommitteeLogin" class="shadow-sm">
                    <option value="">-- Select a Committee --</option>
                    <option value="UNEP">UNEP</option>
                    <option value="Security Council">Security Council</option>
                    <option value="ECOSOC">ECOSOC</option>
                    <option value="NATO">NATO</option>
                    <option value="WHO">WHO</option>
                    <option value="Human Rights">Human Rights</option>
                    <option value="UNESCO">UNESCO</option>
                    <option value="UN WOMEN">UN WOMEN</option>
                    <option value="Historical Crisis">Historical Crisis</option>
                    <option value="GENERAL ASSEMBLY">GENERAL ASSEMBLY</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <button id="proceedToDashboardButton">Proceed to Dashboard</button>
            <div id="committeeMessageBox" class="message-box mt-4"></div>
        </div>

        <div id="dashboard-section" class="hidden w-full">
            <h2 id="dashboard-title" class="text-2xl sm:text-3xl font-extrabold text-center text-purple-700 mb-6 mt-8"></h2>
            <div id="chairs-controls" class="hidden form-group flex flex-col sm:flex-row items-center gap-4 mb-6">
                <label for="filterCommittee" class="whitespace-nowrap">Filter by Committee:</label>
                <select id="filterCommittee" class="shadow-sm flex-grow">
                    <option value="All" selected>All Committees</option>
                    <option value="UNEP">UNEP</option>
                    <option value="Security Council">Security Council</option>
                    <option value="ECOSOC">ECOSOC</option>
                    <option value="NATO">NATO</option>
                    <option value="WHO">WHO</option>
                    <option value="Human Rights">Human Rights</option>
                    <option value="UNESCO">UNESCO</option>
                    <option value="UN WOMEN">UN WOMEN</option>
                    <option value="Historical Crisis">Historical Crisis</option>
                    <option value="GENERAL ASSEMBLY">GENERAL ASSEMBLY</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div id="queries-list" class="w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p id="no-queries-message" class="col-span-full text-center text-gray-500 text-lg hidden">No queries found for this selection.</p>
            </div>

            <div id="faq-management-section" class="hidden w-full">
                <h2 class="font-extrabold text-center text-purple-700 mb-6">FAQ Management</h2>
                <p class="text-gray-600 mb-4 text-sm">Review queries marked for public FAQ and publish them.</p>
                <div id="faq-review-list" class="w-full">
                    <p id="no-faq-review-message" class="text-center text-gray-500 text-lg hidden">No queries pending FAQ review.</p>
                </div>
                <h3 class="text-xl font-bold text-center text-purple-600 mt-8 mb-4">Published FAQs</h3>
                <div id="published-faq-list" class="w-full">
                    <p id="no-published-faq-message" class="text-center text-gray-500 text-lg hidden">No FAQs published yet.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (MUST BE THE SAME AS SUBMISSION PAGE)
        const firebaseConfig = {
            apiKey: "AIzaSyC-He4LJ7KkpqCrZi0Fsc1MXl7Pmyq21sY",
            authDomain: "pyleamun-direct-line.firebaseapp.com",
            projectId: "pyleamun-direct-line",
            storageBucket: "pyleamun-direct-line.firebasestorage.app",
            messagingSenderId: "72053483515",
            appId: "1:72053483515:web:788dab66a9288e642c8d5e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUserId = null;
        let userRole = null; // 'Chairs', 'Secretariat', 'President-Director'
        let selectedCommitteeForChairs = null; // To store the selected committee for Chairs
        const appId = firebaseConfig.projectId; // Using projectId as appId for consistency

        // Hardcoded Passwords
        const PASSWORDS = {
            'Chairs': '@pyleamun26',
            'Secretariat': '@@pyleamun26',
            'President-Director': '@@@5691'
        };

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const committeeSelectionSection = document.getElementById('committee-selection-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const loginMessageBox = document.getElementById('loginMessageBox');
        const selectCommitteeLogin = document.getElementById('selectCommitteeLogin'); // New committee select for login
        const proceedToDashboardButton = document.getElementById('proceedToDashboardButton'); // New button
        const committeeMessageBox = document.getElementById('committeeMessageBox'); // New message box
        const dashboardTitle = document.getElementById('dashboard-title');
        const currentUserSpan = document.getElementById('current-user-id'); // Still referenced in JS, but hidden in HTML
        const chairsControls = document.getElementById('chairs-controls');
        const filterCommitteeSelect = document.getElementById('filterCommittee');
        const queriesList = document.getElementById('queries-list');
        const noQueriesMessage = document.getElementById('no-queries-message');
        const faqManagementSection = document.getElementById('faq-management-section');
        const faqReviewList = document.getElementById('faq-review-list');
        const noFaqReviewMessage = document.getElementById('no-faq-review-message');
        const publishedFaqList = document.getElementById('published-faq-list');
        const noPublishedFaqMessage = document.getElementById('no-published-faq-message');

        // --- UI Utility Functions (reused from pyleamun-direct.html) ---
        function showLoading(message = "Processing...") {
            document.getElementById('loading-overlay').querySelector('p').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showAlert(title, message, callback = null) {
            document.getElementById('custom-alert-title').textContent = title;
            document.getElementById('custom-alert-message').textContent = message;
            document.getElementById('custom-alert-overlay').classList.remove('hidden');
            const okButton = document.getElementById('custom-alert-ok-button');
            okButton.onclick = () => {
                document.getElementById('custom-alert-overlay').classList.add('hidden');
                if (callback) callback();
            };
        }

        /**
         * Displays a temporary message in a dedicated message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error'.
         * @param {HTMLElement} targetMessageBox - The specific message box element to use.
         */
        function showMessageBox(message, type, targetMessageBox) {
            targetMessageBox.textContent = message;
            targetMessageBox.className = `message-box ${type}`;
            targetMessageBox.classList.remove('hidden');
            void targetMessageBox.offsetWidth; // Trigger reflow
            targetMessageBox.style.opacity = '1';
            targetMessageBox.style.transform = 'translateY(0)';

            setTimeout(() => {
                targetMessageBox.style.opacity = '0';
                targetMessageBox.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    targetMessageBox.classList.add('hidden');
                }, 500);
            }, 3000);
        }

        /**
         * Shows a custom confirmation dialog.
         * @param {string} title - Title of the confirmation.
         * @param {string} message - Message for the confirmation.
         * @returns {Promise<boolean>} Resolves true if confirmed, false if cancelled.
         */
        function showConfirmation(title, message) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirmation-overlay');
                const titleElem = document.getElementById('confirmation-title');
                const messageElem = document.getElementById('confirmation-message');
                const okButton = document.getElementById('confirmation-ok-button');
                const cancelButton = document.getElementById('confirmation-cancel-button');

                titleElem.textContent = title;
                messageElem.textContent = message;
                overlay.classList.remove('hidden');

                const handleConfirm = () => {
                    overlay.classList.add('hidden');
                    okButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    overlay.classList.add('hidden');
                    okButton.removeEventListener('click', handleConfirm);
                    cancelButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                okButton.addEventListener('click', handleConfirm);
                cancelButton.addEventListener('click', handleCancel);
            });
        }


        // --- Firebase Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                // We've removed the line that updates currentUserSpan.textContent
                // currentUserSpan.textContent = `Logged in as: ${currentUserId}`;
                console.log("Staff user signed in (anonymous):", currentUserId);
                // If userRole is already set (e.g., from a previous session or direct login after refresh),
                // then show the dashboard, otherwise wait for password entry.
                if (userRole) {
                    // For Chairs, if role is set but committee isn't, show committee selection.
                    if (userRole === 'Chairs' && !selectedCommitteeForChairs) {
                        loginSection.classList.add('hidden');
                        committeeSelectionSection.classList.remove('hidden');
                    } else {
                        showDashboard(userRole);
                    }
                }
            } else {
                console.log("No user signed in for staff access. Signing in anonymously...");
                signInAnonymously(auth)
                    .then(() => {
                        currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                        // We've removed the line that updates currentUserSpan.textContent
                        // currentUserSpan.textContent = `Logged in as: ${currentUserId}`;
                        console.log("Anonymous sign-in successful for staff access. User ID:", currentUserId);
                    })
                    .catch((error) => {
                        console.error("Anonymous sign-in failed for staff access:", error);
                        showAlert("Authentication Error", "Could not sign you in for staff access. Please ensure Anonymous Authentication is enabled.");
                    });
            }
        });

        // --- Login Logic ---
        loginButton.addEventListener('click', () => {
            const enteredPassword = passwordInput.value;
            let authenticated = false;

            for (const role in PASSWORDS) {
                if (PASSWORDS[role] === enteredPassword) {
                    userRole = role;
                    authenticated = true;
                    break;
                }
            }

            if (authenticated) {
                showMessageBox("Login successful!", 'success', loginMessageBox);
                loginSection.classList.add('hidden');

                if (userRole === 'Chairs') {
                    committeeSelectionSection.classList.remove('hidden');
                } else {
                    showDashboard(userRole);
                }
            } else {
                showMessageBox("Invalid password. Please try again.", 'error', loginMessageBox);
                passwordInput.value = ''; // Clear password field
            }
        });

        // --- Committee Selection Logic for Chairs ---
        proceedToDashboardButton.addEventListener('click', () => {
            const selected = selectCommitteeLogin.value;
            if (selected === "") {
                showMessageBox("Please select your committee.", 'error', committeeMessageBox);
                return;
            }
            selectedCommitteeForChairs = selected;
            committeeSelectionSection.classList.add('hidden');
            showDashboard(userRole);
        });


        /**
         * Displays the appropriate dashboard based on the logged-in user's role.
         * @param {string} role - The role of the logged-in user ('Chairs', 'Secretariat', 'President-Director').
         */
        function showDashboard(role) {
            dashboardSection.classList.remove('hidden');
            dashboardTitle.textContent = `Welcome, ${role}!`;

            // Hide all role-specific sections first
            chairsControls.classList.add('hidden');
            faqManagementSection.classList.add('hidden');

            // Show sections based on role
            if (role === 'Chairs') {
                chairsControls.classList.remove('hidden');
                // Set the filter committee dropdown to the selected committee from login
                filterCommitteeSelect.value = selectedCommitteeForChairs;
                setupQueriesListener(); // Start listening for queries based on selected committee
            } else if (role === 'Secretariat') {
                faqManagementSection.classList.remove('hidden');
                chairsControls.classList.remove('hidden'); // Secretariat can also use committee filter
                filterCommitteeSelect.value = "All"; // Default to all committees for Secretariat
                setupQueriesListener(); // Secretariat sees all queries (or can filter)
                setupFaqListeners(); // And manage FAQ
            } else if (role === 'President-Director') {
                faqManagementSection.classList.remove('hidden'); // PD can also manage FAQ
                chairsControls.classList.remove('hidden'); // PD can also use committee filter
                filterCommitteeSelect.value = "All"; // Default to all committees for PD
                setupQueriesListener(); // PD can see all queries
                setupFaqListeners();
            }
        }

        // --- Query Management ---
        let unsubscribeQueries = null; // To store the unsubscribe function for onSnapshot

        /**
         * Sets up a real-time listener for queries based on the user's role and filters.
         */
        function setupQueriesListener() {
            if (unsubscribeQueries) {
                unsubscribeQueries(); // Unsubscribe from previous listener if exists
            }

            showLoading("Loading queries...");
            let queriesCollectionRef = collection(db, `artifacts/${appId}/public/data/queries`);
            let q;

            if (userRole === 'Chairs') {
                // Chairs filter by their specific selected committee
                q = query(queriesCollectionRef, where('target', '==', 'Chairs'), where('committeeSpecific', '==', selectedCommitteeForChairs), orderBy('timestamp', 'desc'));
            } else if (userRole === 'Secretariat' || userRole === 'President-Director') {
                // Secretariat and PD can filter by the filterCommitteeSelect in the dashboard
                const selectedFilterCommittee = filterCommitteeSelect.value;
                if (selectedFilterCommittee === 'All') {
                    q = query(queriesCollectionRef, orderBy('timestamp', 'desc'));
                } else {
                    // They can filter by either target or committeeSpecific depending on need.
                    // For now, let's filter by committeeSpecific for consistency with Chairs' view.
                    q = query(queriesCollectionRef, where('committeeSpecific', '==', selectedFilterCommittee), orderBy('timestamp', 'desc'));
                }
            } else {
                queriesList.innerHTML = '<p class="col-span-full text-center text-gray-500 text-lg">Select a role and committee to view queries.</p>';
                hideLoading();
                return;
            }

            unsubscribeQueries = onSnapshot(q, (snapshot) => {
                queriesList.innerHTML = ''; // Clear existing queries
                const queries = [];
                snapshot.forEach((doc) => {
                    queries.push({ id: doc.id, ...doc.data() });
                });

                if (queries.length === 0) {
                    noQueriesMessage.classList.remove('hidden');
                } else {
                    noQueriesMessage.classList.add('hidden');
                    queries.forEach(queryData => {
                        renderQueryCard(queryData);
                    });
                }
                hideLoading();
            }, (error) => {
                console.error("Error fetching queries:", error);
                showAlert("Error", "Could not load queries. Please check console for details.");
                hideLoading();
            });
        }

        // Event listener for committee filter change (Chairs, Secretariat, PD)
        filterCommitteeSelect.addEventListener('change', setupQueriesListener);

        /**
         * Renders a single query as a card in the dashboard.
         * @param {object} queryData - The query document data.
         */
        function renderQueryCard(queryData) {
            const queryCard = document.createElement('div');
            queryCard.className = 'query-card';
            queryCard.dataset.id = queryData.id;

            let statusClass = '';
            switch (queryData.status) {
                case 'New': statusClass = 'status-new'; break;
                case 'Reviewed': statusClass = 'status-reviewed'; break;
                case 'Answered': statusClass = 'status-answered'; break;
                case 'Archived': statusClass = 'status-archived'; break;
            }

            const timestamp = queryData.timestamp ? new Date(queryData.timestamp.toDate()).toLocaleString() : 'N/A';

            queryCard.innerHTML = `
                <h3 class="flex justify-between items-center">
                    <span>Query for: ${queryData.target}</span>
                    <span class="text-sm ${statusClass}">${queryData.status}</span>
                </h3>
                <p><strong>From:</strong> ${queryData.isAnonymous ? 'Anonymous' : queryData.senderName}</p>
                <p><strong>Committee:</strong> ${queryData.senderCommittee}</p>
                <p><strong>Email:</strong> ${queryData.isAnonymous ? 'N/A' : queryData.senderEmail}</p>
                <p><strong>Message:</strong> ${queryData.message}</p>
                <p class="text-xs text-gray-500 mt-2">Submitted: ${timestamp}</p>
                ${queryData.answer ? `
                    <div class="answer-section">
                        <strong>Answer:</strong> ${queryData.answer}
                        <p class="text-xs text-gray-500 mt-1">Answered by: ${queryData.answeredBy} on ${queryData.answerTimestamp ? new Date(queryData.answerTimestamp.toDate()).toLocaleString() : 'N/A'}</p>
                    </div>
                ` : `
                    <div class="answer-input-group">
                        <textarea placeholder="Type your answer here..." data-query-id="${queryData.id}"></textarea>
                    </div>
                `}
                <div class="action-buttons">
                    ${userRole !== 'Chairs' ? `<button class="action-button info-button" onclick="forwardQuery('${queryData.id}')">Forward</button>` : ''}
                    ${queryData.status === 'New' ? `<button class="action-button" onclick="markQueryStatus('${queryData.id}', 'Reviewed')">Mark Reviewed</button>` : ''}
                    ${!queryData.answer ? `<button class="action-button" onclick="submitAnswer('${queryData.id}')">Submit Answer</button>` : ''}
                    ${userRole === 'Secretariat' || userRole === 'President-Director' ? `
                        <button class="action-button ${queryData.isVisibleToPublic ? 'bg-blue-500 hover:bg-blue-600' : 'bg-orange-500 hover:bg-orange-600'}"
                                onclick="toggleFaqVisibility('${queryData.id}', ${queryData.isVisibleToPublic})">
                            ${queryData.isVisibleToPublic ? 'Remove from FAQ Review' : 'Mark for FAQ Review'}
                        </button>
                    ` : ''}
                    ${userRole === 'President-Director' ? `<button class="action-button delete-button" onclick="deleteQuery('${queryData.id}')">Delete Query</button>` : ''}
                </div>
            `;
            queriesList.appendChild(queryCard);
        }

        /**
         * Updates the status of a query in Firestore.
         * @param {string} queryId - The ID of the query document.
         * @param {string} newStatus - The new status ('Reviewed', 'Answered', 'Archived').
         */
        window.markQueryStatus = async (queryId, newStatus) => {
            showLoading(`Marking as ${newStatus}...`);
            try {
                const queryRef = doc(db, `artifacts/${appId}/public/data/queries`, queryId);
                await updateDoc(queryRef, {
                    status: newStatus
                });
                showMessageBox(`Query marked as ${newStatus}!`, 'success', loginMessageBox);
            } catch (error) {
                console.error("Error updating query status:", error);
                showAlert("Error", `Failed to mark query as ${newStatus}.`);
            } finally {
                hideLoading();
            }
        };

        /**
         * Submits an answer to a query.
         * @param {string} queryId - The ID of the query document.
         */
        window.submitAnswer = async (queryId) => {
            const textarea = queriesList.querySelector(`.query-card[data-id="${queryId}"] textarea`);
            const answer = textarea ? textarea.value.trim() : '';

            if (!answer) {
                showAlert("Validation Error", "Please type an answer before submitting.");
                return;
            }

            showLoading("Submitting answer...");
            try {
                const queryRef = doc(db, `artifacts/${appId}/public/data/queries`, queryId);
                await updateDoc(queryRef, {
                    answer: answer,
                    answeredBy: userRole,
                    answerTimestamp: new Date(),
                    status: 'Answered' // Automatically mark as answered
                });
                showMessageBox("Answer submitted and query marked as Answered!", 'success', loginMessageBox);
            } catch (error) {
                console.error("Error submitting answer:", error);
                showAlert("Error", "Failed to submit answer.");
            } finally {
                hideLoading();
            }
        };

        /**
         * Toggles the isVisibleToPublic status of a query for FAQ review.
         * @param {string} queryId - The ID of the query document.
         * @param {boolean} currentStatus - The current isVisibleToPublic status.
         */
        window.toggleFaqVisibility = async (queryId, currentStatus) => {
            showLoading(currentStatus ? "Removing from FAQ review..." : "Marking for FAQ review...");
            try {
                const queryRef = doc(db, `artifacts/${appId}/public/data/queries`, queryId);
                await updateDoc(queryRef, {
                    isVisibleToPublic: !currentStatus
                });
                showMessageBox(`Query ${currentStatus ? 'removed from' : 'marked for'} FAQ review.`, 'success', loginMessageBox);
            } catch (error) {
                console.error("Error toggling FAQ visibility:", error);
                showAlert("Error", "Failed to update FAQ visibility.");
            } finally {
                hideLoading();
            }
        };

        /**
         * Deletes a query document (President-Director only).
         * @param {string} queryId - The ID of the query document.
         */
        window.deleteQuery = async (queryId) => {
            const confirmed = await showConfirmation("Delete Query", "Are you sure you want to permanently delete this query? This action cannot be undone.");
            if (!confirmed) {
                return;
            }

            showLoading("Deleting query...");
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/queries`, queryId));
                showMessageBox("Query deleted successfully!", 'success', loginMessageBox);
            } catch (error) {
                console.error("Error deleting query:", error);
                showAlert("Error", "Failed to delete query.");
            } finally {
                hideLoading();
            }
        };

        /**
         * Placeholder for forwarding logic (e.g., changing target or notifying another staff member).
         * For now, it just shows an alert.
         * @param {string} queryId - The ID of the query document.
         */
        window.forwardQuery = (queryId) => {
            showAlert("Forward Query", `Functionality to forward query ${queryId} to another staff member would be implemented here. This could involve changing its target, or sending an internal notification.`);
        };


        // --- FAQ Management (Secretariat & President-Director) ---
        let unsubscribeFaqReview = null;
        let unsubscribePublishedFaq = null;

        function setupFaqListeners() {
            if (unsubscribeFaqReview) unsubscribeFaqReview();
            if (unsubscribePublishedFaq) unsubscribePublishedFaq();

            // Listen for queries marked for FAQ review
            const faqReviewQuery = query(
                collection(db, `artifacts/${appId}/public/data/queries`),
                where('isVisibleToPublic', '==', true),
                orderBy('timestamp', 'desc')
            );

            unsubscribeFaqReview = onSnapshot(faqReviewQuery, (snapshot) => {
                faqReviewList.innerHTML = '';
                const reviewItems = [];
                snapshot.forEach(doc => {
                    reviewItems.push({ id: doc.id, ...doc.data() });
                });

                if (reviewItems.length === 0) {
                    noFaqReviewMessage.classList.remove('hidden');
                } else {
                    noFaqReviewMessage.classList.add('hidden');
                    reviewItems.forEach(item => {
                        renderFaqReviewItem(item);
                    });
                }
            }, (error) => {
                console.error("Error fetching FAQ review items:", error);
            });

            // Listen for published FAQ items
            const publishedFaqQuery = query(
                collection(db, `artifacts/${appId}/public/data/faq`),
                orderBy('timestamp', 'desc')
            );

            unsubscribePublishedFaq = onSnapshot(publishedFaqQuery, (snapshot) => {
                publishedFaqList.innerHTML = '';
                const publishedItems = [];
                snapshot.forEach(doc => {
                    publishedItems.push({ id: doc.id, ...doc.data() });
                });

                if (publishedItems.length === 0) {
                    noPublishedFaqMessage.classList.remove('hidden');
                } else {
                    noPublishedFaqMessage.classList.add('hidden');
                    publishedItems.forEach(item => {
                        renderPublishedFaqItem(item);
                    });
                }
            }, (error) => {
                console.error("Error fetching published FAQ items:", error);
            });
        }

        /**
         * Renders an item in the FAQ review list.
         * @param {object} item - The query data.
         */
        function renderFaqReviewItem(item) {
            const faqItemDiv = document.createElement('div');
            faqItemDiv.className = 'faq-item';
            faqItemDiv.innerHTML = `
                <p><strong>Q:</strong> ${item.message}</p>
                ${item.answer ? `<p><strong>A:</strong> ${item.answer}</p>` : '<p class="text-red-500">No answer provided yet.</p>'}
                <p class="text-xs text-gray-500">Target: ${item.target} | From: ${item.isAnonymous ? 'Anonymous' : item.senderName}</p>
                <div class="faq-actions">
                    <button class="action-button bg-green-500 hover:bg-green-600" onclick="publishFaq('${item.id}', '${escapeHtml(item.message)}', '${escapeHtml(item.answer)}')">Publish FAQ</button>
                    <button class="action-button bg-red-500 hover:bg-red-600" onclick="toggleFaqVisibility('${item.id}', true)">Reject/Remove</button>
                </div>
            `;
            faqReviewList.appendChild(faqItemDiv);
        }

        /**
         * Renders a published FAQ item.
         * @param {object} item - The FAQ document data.
         */
        function renderPublishedFaqItem(item) {
            const faqItemDiv = document.createElement('div');
            faqItemDiv.className = 'faq-item bg-blue-50'; // Slightly different background for published
            faqItemDiv.innerHTML = `
                <p><strong>Q:</strong> ${item.question}</p>
                <p><strong>A:</strong> ${item.answer}</p>
                <p class="text-xs text-gray-500">Published: ${item.timestamp ? new Date(item.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                <div class="faq-actions">
                    <button class="action-button delete-button" onclick="deleteFaq('${item.id}')">Delete FAQ</button>
                </div>
            `;
            publishedFaqList.appendChild(faqItemDiv);
        }

        /**
         * Publishes a query to the public FAQ collection.
         * @param {string} queryId - The ID of the original query.
         * @param {string} question - The question text.
         * @param {string} answer - The answer text.
         */
        window.publishFaq = async (queryId, question, answer) => {
            if (!answer || answer === 'N/A') {
                showAlert("Cannot Publish", "Please ensure the query has an answer before publishing to FAQ.");
                return;
            }
            const confirmed = await showConfirmation("Publish FAQ", "Are you sure you want to publish this Q&A to the public FAQ?");
            if (!confirmed) {
                return;
            }

            showLoading("Publishing FAQ...");
            try {
                // Add to public FAQ collection
                await addDoc(collection(db, `artifacts/${appId}/public/data/faq`), {
                    question: question,
                    answer: answer,
                    originalQueryId: queryId, // Link back to original query
                    timestamp: new Date(),
                    publishedBy: userRole
                });

                // Optionally, mark original query as archived or handled
                await updateDoc(doc(db, `artifacts/${appId}/public/data/queries`, queryId), {
                    status: 'Archived', // Or 'Published'
                    isVisibleToPublic: false // Remove from review list
                });

                showMessageBox("FAQ published successfully!", 'success', loginMessageBox);
            } catch (error) {
                console.error("Error publishing FAQ:", error);
                showAlert("Error", "Failed to publish FAQ.");
            } finally {
                hideLoading();
            }
        };

        /**
         * Deletes a published FAQ item.
         * @param {string} faqId - The ID of the FAQ document.
         */
        window.deleteFaq = async (faqId) => {
            const confirmed = await showConfirmation("Delete FAQ", "Are you sure you want to permanently delete this FAQ entry? This action cannot be undone.");
            if (!confirmed) {
                return;
            }

            showLoading("Deleting FAQ...");
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/faq`, faqId));
                showMessageBox("FAQ deleted successfully!", 'success', loginMessageBox);
            } catch (error) {
                console.error("Error deleting FAQ:", error);
                showAlert("Error", "Failed to delete FAQ.");
            } finally {
                hideLoading();
            }
        };

        /**
         * Utility function to escape HTML for safe display
         * @param {string} str - The string to escape.
         * @returns {string} The escaped string.
         */
        function escapeHtml(str) {
            if (typeof str !== 'string') return str; // Return non-strings as-is
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // Initial setup on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure Firebase Auth is ready before trying to sign in
            // onAuthStateChanged handles the initial sign-in
        });
    </script>
</body>
</html>